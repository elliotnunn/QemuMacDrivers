# Important to remember that a DRVR is all statically linked: no system libs

BUILD = build-drvr

CC = m68k-apple-macos-gcc
CFLAGS = -c -O3 -mpcrel -mcpu=68020 -nostartfiles -ffreestanding -ffunction-sections -fdata-sections

AS = m68k-apple-macos-as
ASFLAGS =

COMMON = \
	$(BUILD)/drvr.o \
	$(BUILD)/allocator-drvr.o \
	$(BUILD)/transport-mmio.o \
	$(BUILD)/virtqueue.o \
	$(BUILD)/patch68k.o \
	$(BUILD)/panic.o \
	$(BUILD)/printf.o \

$(shell mkdir -p $(BUILD))

$(BUILD)/declrom: $(BUILD)/declrom.elf
	m68k-apple-macos-objcopy --only-section .text -O binary $^ $@
	./calculate_crc.lua $@ $@

$(BUILD)/declrom.elf: $(BUILD)/declrom.o
	m68k-apple-macos-ld -o $@ $^

$(BUILD)/declrom.o: declrom.s $(BUILD)/device-input.drvr
	$(AS) $(ASFLAGS) -o $@ $<

$(BUILD)/%.o: %.c
	$(CC) $(CFLAGS) -o $@ $^

$(BUILD)/%.o: %.s
	$(AS) $(ASFLAGS) -o $@ $^

$(BUILD)/device-%.drvr: $(BUILD)/device-%.elf
	m68k-apple-macos-objcopy --only-section .drvr -O binary $^ $@

$(BUILD)/device-input.elf: drvr.lds $(BUILD)/device-input.o $(COMMON)
	m68k-apple-macos-ld --gc-sections -o $@ --script $^ `m68k-apple-macos-gcc -print-file-name=libgcc.a` `m68k-apple-macos-gcc -print-file-name=libc.a`

$(BUILD)/device-9p.elf: drvr.lds $(BUILD)/device-9p.o $(COMMON) $(BUILD)/9p.o $(BUILD)/universalfcb.o $(BUILD)/hashtab.o $(BUILD)/unicode.o $(BUILD)/paramblkprint.o
	m68k-apple-macos-ld --gc-sections -o $@ --script $^ `m68k-apple-macos-gcc -print-file-name=libgcc.a` `m68k-apple-macos-gcc -print-file-name=libc.a` `m68k-apple-macos-gcc -print-file-name=libg.a` `m68k-apple-macos-gcc -print-file-name=libm.a` `m68k-apple-macos-gcc -print-file-name=libstdc++.a`

clean:
	rm -rf $(BUILD)
