# Important to remember that a DRVR is all statically linked: no system libs

BUILD = build-drvr

CC = m68k-apple-macos-gcc
CFLAGS = -c -O3 -mpcrel -mcpu=68020 -nostartfiles -ffreestanding -ffunction-sections -fdata-sections

AS = m68k-apple-macos-as
ASFLAGS =

$(shell mkdir -p $(BUILD))

$(BUILD)/declrom: $(BUILD)/declrom.elf
	m68k-apple-macos-objcopy --only-section .text -O binary $^ $@
	./calculate_crc.lua $@ $@

$(BUILD)/declrom.elf: $(BUILD)/declrom.o
	m68k-apple-macos-ld -o $@ $^

$(BUILD)/declrom.o: declrom.s $(BUILD)/device-input.drvr
	$(AS) $(ASFLAGS) -o $@ $<

$(BUILD)/%.o: %.c
	$(CC) $(CFLAGS) -o $@ $^

$(BUILD)/%.o: %.s
	$(AS) $(ASFLAGS) -o $@ $^

$(BUILD)/device-%.drvr: $(BUILD)/device-%.elf
	m68k-apple-macos-objcopy --only-section .drvr -O binary $^ $@

$(BUILD)/device-input.elf: drvr.lds $(BUILD)/drvr.o \
                           $(BUILD)/printf.o \
                           $(BUILD)/device-input.o
	m68k-apple-macos-ld --gc-sections -o $@ --script $^ `m68k-apple-macos-gcc -print-file-name=libgcc.a`

clean:
	rm -rf $(BUILD)
