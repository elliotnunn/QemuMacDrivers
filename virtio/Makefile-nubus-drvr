# Important to remember that a DRVR is all statically linked: no system libs

BUILD = build-drvr

CC = m68k-apple-macos-gcc
CFLAGS = -c -Os -mcpu=68020 -nostartfiles -ffreestanding -ffunction-sections -fdata-sections

AS = m68k-apple-macos-as
ASFLAGS =

LD = m68k-apple-macos-ld
LDFLAGS = --emit-relocs --gc-sections

# Not acutally common-to-all, but this simplifies the Makefile!
COMMON = \
	$(BUILD)/9p.o \
	$(BUILD)/allocator-drvr.o \
	$(BUILD)/drvr.o \
	$(BUILD)/hashtab.o \
	$(BUILD)/panic.o \
	$(BUILD)/paramblkprint.o \
	$(BUILD)/patch68k.o \
	$(BUILD)/printf.o \
	$(BUILD)/transport-mmio.o \
	$(BUILD)/unicode.o \
	$(BUILD)/universalfcb.o \
	$(BUILD)/virtqueue.o \

STANDARD = $(shell for x in libInterface.a libgcov.a libg.a libm.a libstdc++.a libgcc.a libc.a; do m68k-apple-macos-gcc -print-file-name=$$x; done)

$(shell mkdir -p $(BUILD))

$(BUILD)/declrom: $(BUILD)/declrom.elf
	m68k-apple-macos-objcopy --only-section .text -O binary $^ $@
	./calculate_crc.lua $@ $@

$(BUILD)/declrom.elf: $(BUILD)/declrom.o
	m68k-apple-macos-ld -o $@ $^

$(BUILD)/declrom.o: declrom.s $(BUILD)/primaryinit.bin $(BUILD)/device-input.drvr $(BUILD)/device-9p.drvr
	$(AS) $(ASFLAGS) -o $@ $<

$(BUILD)/primaryinit.bin: primaryinit.c
	$(CC) -c -mpcrel -nostdlib -nostartfiles -ffreestanding -o $(BUILD)/primaryinit.o $^
	m68k-apple-macos-ld -e primaryinit -o $(BUILD)/primaryinit.elf $(BUILD)/primaryinit.o $(STANDARD)
	m68k-apple-macos-objcopy --only-section .text -O binary $(BUILD)/primaryinit.elf $@

$(BUILD)/%.o: %.c
	$(CC) $(CFLAGS) -o $@ $^

$(BUILD)/%.o: %.s
	$(AS) $(ASFLAGS) -o $@ $^

$(BUILD)/device-%.drvr: $(BUILD)/device-%.elf
	m68k-apple-macos-objcopy --only-section .drvr -O binary $^ $@
	@# Append a list of relocations to the drvr
	(m68k-apple-macos-objdump -r $^ | fgrep R_68K_32; echo 00000000) | cut -w -f1 | xxd -r -p >>$@

$(BUILD)/device-%.elf: drvr.lds $(BUILD)/device-%.o $(COMMON)
	m68k-apple-macos-ld --emit-relocs --gc-sections -o $@ --script $^ $(STANDARD)

clean:
	rm -rf $(BUILD)
